name: Deploy HPC Agent Hub to Azure Container Apps

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP }}
  ACR_NAME: ${{ secrets.ACR_NAME }}
  APP_NAME: ${{ secrets.APP_NAME }}
  FRONTEND_DOMAIN: ${{ secrets.FRONTEND_DOMAIN }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: ğŸ” Azure Login with OIDC
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: ğŸ·ï¸ Generate build timestamp
        id: timestamp
        run: echo "timestamp=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
      
      - name: ğŸ”¨ Build and push Frontend image
        run: |
          echo "ğŸ”¨ Building frontend image with tag: ${{ steps.timestamp.outputs.timestamp }}"
          az acr build \
            --registry ${{ env.ACR_NAME }} \
            --image frontend:${{ steps.timestamp.outputs.timestamp }} \
            --image frontend:latest \
            --build-arg CACHEBUST=${{ github.sha }} \
            --file ./frontend/Dockerfile \
            ./frontend
      
      - name: ğŸ”¨ Build and push Backend image
        run: |
          echo "ğŸ”¨ Building backend image with tag: ${{ steps.timestamp.outputs.timestamp }}"
          az acr build \
            --registry ${{ env.ACR_NAME }} \
            --image backend:${{ steps.timestamp.outputs.timestamp }} \
            --image backend:latest \
            --build-arg CACHEBUST=${{ github.sha }} \
            --file ./backend/Dockerfile \
            ./backend
      
      - name: ğŸš€ Deploy Backend Container App
        run: |
          echo "ğŸš€ Deploying backend version: ${{ steps.timestamp.outputs.timestamp }}"
          az containerapp update \
            --name "${{ env.APP_NAME }}-backend" \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image "${{ env.ACR_NAME }}.azurecr.io/backend:${{ steps.timestamp.outputs.timestamp }}"
      
      - name: ğŸš€ Deploy Frontend Container App
        run: |
          echo "ğŸš€ Deploying frontend version: ${{ steps.timestamp.outputs.timestamp }}"
          az containerapp update \
            --name "${{ env.APP_NAME }}-frontend" \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image "${{ env.ACR_NAME }}.azurecr.io/frontend:${{ steps.timestamp.outputs.timestamp }}"
      
      - name: âœ… Deployment Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ DEPLOYMENT COMPLETE!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Version: ${{ steps.timestamp.outputs.timestamp }}"
          echo "ğŸŒ Frontend: https://${{ env.APP_NAME }}-frontend.${{ env.FRONTEND_DOMAIN }}"
          echo "ğŸ”§ Backend: https://${{ env.APP_NAME }}-backend.${{ env.FRONTEND_DOMAIN }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"